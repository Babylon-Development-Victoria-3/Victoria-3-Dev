# Root = Diplomatic Play
on_diplo_play_back_down = {
	effect = {
		if = {
			#If somebody backs down while nobody has joined the original customs union play....
			limit = {
				is_diplomatic_play_type = dp_customs_union
				OR = {
					initiator_is = scope:actor
					target_is = scope:actor
				}
			}
			initiator = {
				save_scope_as = overlord_scope
				clear_variable_list = babylon_new_customs_union_overlord
			}
			target = {
				remove_diplomatic_pact = {
					country = scope:overlord_scope
					type = customs_union
				}
				save_scope_as = applicant_scope
				clear_variable_list = babylon_new_customs_union_applicant
				set_variable = {
					name = babylon_new_customs_union_applicant_denied
					value = 1
					days = 1826					#5 years
				}
			}
			#Ends play to prevent war goals from firing
			end_play = yes
			#creates truces to simulate the ending of a play... 
			scope:overlord_scope = {
				create_truce = {
					country = scope:applicant_scope
					months = 60
				}
			}
		}
		if = {
			#If 
			limit = {
				#Play is dp_liberate_subject 
				is_diplomatic_play_type = dp_liberate_subject
				#And the target is an applicant
				target = {
					has_variable_list = babylon_new_customs_union_applicant
				}
				#Assume its the 2nd stage of dp_customs_union
				#Then check if the backdowner (lol) is the target/applicant
				target_is = scope:actor
			}
			#Get the customs union overlord
			#In a =(&/%)! stupid way
			random_country = {
				limit = {
					#Check if random country is an overlord
					has_variable_list = babylon_new_customs_union_overlord
					#Of the applicant...
					is_target_in_variable_list = {
						name = babylon_new_customs_union_overlord
						target = scope:actor
					}
				}
				save_scope_as = overlord_scope
			}
			#Remove customs union
			target = {
				remove_diplomatic_pact = {
					country = scope:overlord_scope
					type = customs_union
				}
				#Clear a variable
				clear_variable_list = babylon_new_customs_union_applicant
				#Add a 5 year cooldown to adding the applicant to a customs union
				set_variable = {
					name = babylon_new_customs_union_applicant_denied
					value = 1
					days = 1826					#5 years
				}
			}
			#Clear another variable
			scope:overlord_scope = {
				clear_variable_list = babylon_new_customs_union_overlord
			}
		}
	}
}

# Root = Diplomatic Play
on_diplo_play_join_side = {
	effect = {
		if = {
			limit = {
				#Upon someone joining the customs union play on the side of the applicant...
				is_diplomatic_play_type = dp_customs_union
				NOT = {
					has_variable = someone_objected
				}
				any_scope_target_ally = {
					this = scope:actor
				}
			}
			#So it only fires once
			#Cleans itself up after 7 days
			set_variable = {
				name = someone_objected
				value = 1
				days = 7
			}
			#Add the overlord allies to a variable list in the applicant
			every_scope_initiator_ally = {
				root.target = {
					add_to_variable_list = {
						name = custom_union_overlord_backers
						target = prev
					}
				}
			}
			end_play = yes
			scope:actor = {
				create_diplomatic_play = {
					type = dp_liberate_subject
					target_country = root.target
					add_target_backers = {
						root.initiator
					}
					add_war_goal = {
						holder = scope:actor
						type = humiliation
						target_country = root.initiator
					}
				}
			}
		}
	}
}

on_diplo_play_start = {
	effect = {
		if = {
			limit = {
				#Is liberate subject
				is_diplomatic_play_type = dp_liberate_subject
				#And target is an applicant
				target = {
					has_variable_list = babylon_new_customs_union_applicant
				}
			}
			#Iterate through overlords backers
			ordered_in_list = {
				variable = custom_union_overlord_backers
				#And add them to the new play
				root = {
					add_target_backers = {
						prev
					}
				}
			}
			#Then get rid of the list
			clear_variable_list = custom_union_overlord_backers
		}
	}
}
