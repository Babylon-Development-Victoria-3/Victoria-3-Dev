babylon_vienna_congress_compile_lists = {
	# Get rid of the previous list (if they exist, only relevant the first monthly tick)
	clear_global_variable_list ?= babylon_congress_great_powers
	clear_global_variable_list ?= babylon_congress_major_powers
	# Then we get the sorted countries
	ordered_country = {
		limit = {
			country_rank = rank_value:great_power
		}
		order_by = prestige
		max = babylon_num_of_great_powers
		add_to_global_variable_list = {
			name = babylon_congress_great_powers
			target = this
		}
	}
	ordered_country = {
		limit = {
			country_rank = rank_value:major_power
		}
		order_by = prestige
		max = babylon_num_of_major_powers
		add_to_global_variable_list = {
			name = babylon_congress_major_powers
			target = this
		}
	}
	every_country = {
		clear_variable_list ?= current_states
		every_scope_state = {
			prev = {
				add_to_variable_list = {
					name = current_states
					target = prev
				}
			}
		}
	}
}

congress_start_conference = {
	if = {
		limit = {
			# Only start conference if its not in session.
			# Shouldnt be neccesary, but here as redundancy
			NOT = {
				has_global_variable = babylon_vienna_congress_in_session
			}
		}
		# Remove previous global variables
		clear_global_variable_list ?= current_congress_members_on_stance_1
		clear_global_variable_list ?= current_congress_members_on_stance_2
		clear_global_variable_list ?= current_congress_members_on_stance_3
		set_global_variable = {
			name = babylon_vienna_congress_in_session
		}
		set_global_variable = {
			name = babylon_vienna_congress_minimum_time
			days = 30
		}
		if = {
			limit = {
				NOT = {
					has_global_variable = babylon_vienna_congress_current_session
				}
			}
			set_global_variable = {
				name = babylon_vienna_congress_current_session
				value = 1
			}
		}
		else = {
			change_global_variable = {
				name = babylon_vienna_congress_current_session
				add = 1
			}
		}
		if = {
			limit = {
				$TYPE$ = 1
				# Denouncement
			}
			$TARGET$ = {
				capital = {
					save_scope_as = target_state
				}
			}
		}
		if = {
			limit = {
				$TYPE$ = 2
				# State Claim
			}
			$TARGET_STATE$ = {
				save_scope_as = target_state
			}
		}
		if = {
			limit = {
				$TYPE$ = 3
				# Embargo
			}
			$TARGET$ = {
				capital = {
					save_scope_as = target_state
				}
			}
		}
		if = {
			limit = {
				$TYPE$ = 4
				# Recognises Country
			}
			$TARGET$ = {
				capital = {
					save_scope_as = target_state
				}
			}
		}
		congress_initialise_conference_global_vars = {
			TYPE = $TYPE$
			TARGET = $TARGET$
			INITIATOR = $INITIATOR$
			TARGET_STATE = scope:target_state
		}
		every_country = {
			limit = {
				OR = {
					is_target_in_global_variable_list = {
						name = babylon_congress_great_powers
						target = this
					}
					is_target_in_global_variable_list = {
						name = babylon_congress_major_powers
						target = this
					}
					AND = {
						# If target is recognised he gets a say
						global_var:babylon_vienna_congress_session_target = this
						is_country_type = recognized
					}
				}
			}
			set_variable = conference_member
			set_congress_stance_effect = {
				COUNTRY = this
				STANCE = 2
			}
		}
		$TARGET$ = {
			if = {
				limit = {
					has_variable = conference_member
				}
				set_congress_stance_effect = {
					COUNTRY = this
					STANCE = 3
				}
			}
		}
		$INITIATOR$ = {
			set_congress_stance_effect = {
				COUNTRY = this
				STANCE = 1
			}
		}
		every_country = {
			limit = {
				NOT = {
					this = $INITIATOR$
				}
			}
			post_notification = babylon_vienna_congress_started
		}
	}
}


aftermath_event_choice = {
	# NEEDS FILLING IN ACCORDING TO TYPE
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 1
		}
		trigger_event = {
			id = conference_aftermath_denouncement.1
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 2
		}
		trigger_event = {
			id = conference_aftermath_denouncement.1
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 3
		}
		trigger_event = {
			id = conference_aftermath_denouncement.1
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 4
		}
		trigger_event = {
			id = conference_aftermath_denouncement.1
			popup = yes
		}
	}
}


congress_initialise_conference_global_vars = {
	set_global_variable = {
		name = babylon_vienna_congress_session_type
		value = $TYPE$
	}
	set_global_variable = {
		name = babylon_vienna_congress_session_target
		value = $TARGET$
	}
	set_global_variable = {
		name = babylon_vienna_congress_session_initiator
		value = $INITIATOR$
	}
	set_global_variable = {
		name = babylon_vienna_congress_session_target_state
		value = $TARGET_STATE$
	}
}

set_congress_stance_effect = {
	if = {
		limit = {
			is_target_in_global_variable_list = {
				name = current_congress_members_on_stance_1
				target = $COUNTRY$
			}
		}
		remove_list_global_variable = {
			name = current_congress_members_on_stance_1
			target = $COUNTRY$
		}
	}
	if = {
		limit = {
			is_target_in_global_variable_list = {
				name = current_congress_members_on_stance_2
				target = $COUNTRY$
			}
		}
		remove_list_global_variable = {
			name = current_congress_members_on_stance_2
			target = $COUNTRY$
		}
	}
	if = {
		limit = {
			is_target_in_global_variable_list = {
				name = current_congress_members_on_stance_3
				target = $COUNTRY$
			}
		}
		remove_list_global_variable = {
			name = current_congress_members_on_stance_3
			target = $COUNTRY$
		}
	}
	add_to_global_variable_list = {
		name = current_congress_members_on_stance_$STANCE$
		target = $COUNTRY$
	}
}

# Needs to be in country scope
adjust_opinions_conference_voters_reject = {
	every_in_global_list = {
		variable = current_congress_members_on_stance_1
		limit = {
			this != prev
		}
		change_relations = {
			country = prev
			value = {
				add = -50
				multiply = conference_sanctions_severity
			}
		}
	}

	every_in_global_list = {
		variable = current_congress_members_on_stance_3
		limit = {
			this != prev
		}
		change_relations = {
			country = prev
			value = {
				add = 50
				multiply = conference_sanctions_severity
			}
		}
	}
}

# scope: country
# defined: scope:target_country
denounce_target = {
	change_relations = {
		country = scope:target_country
		value = {
			add = -50
			multiply = conference_sanctions_severity
		}
	}
}

# scope: country
denouncement_effect = {
	if = {
		limit = {
			conference_sanctions_severity != 0
		}

		add_modifier = {
			name = babylon_congress_denouncement_modifier
			years = 3
			multiplier = conference_sanctions_severity
		}
		save_temporary_scope_value_as = {
			name = infamy_addition
			value = {
				add = 30
				multiply = conference_sanctions_severity
			}
		}
		change_infamy = scope:infamy_addition
	}
}

state_claim_target = {
	if = {
		limit = {
			conference_sanctions_severity != 0.5
		}
		every_in_global_list = {
			variable = current_congress_members_on_stance_1
			change_relations = {
				country = global_var:babylon_vienna_congress_session_target
				value = -50
			}
			global_var:babylon_vienna_congress_session_target = {
				change_relations = {
					country = prev
					value = -50
				}
			}
		}
		$TARGET$.state_region = {
			add_claim = global_var:babylon_vienna_congress_session_initiator
		}
	}
}

embargo_target = {
	if = {
		limit = {
			conference_sanctions_severity != 0
		}
		every_in_global_list = {
			variable = current_congress_members_on_stance_1
			change_relations = {
				country = $TARGET$
				value = -50
			}
			create_diplomatic_pact = {
				country = $TARGET$
				type = forced_embargo_pact
			}
		}
		every_in_global_list = {
			variable = current_congress_members_on_stance_1
			$TARGET$ = {
				change_relations = {
					country = prev
					value = -50
				}
			}
		}
		$TARGET$ = {
			add_modifier = {
				name = forced_embargo
				years = 3
				multiplier = conference_sanctions_severity
			}
		}
	}
}

recognise_target = {
	if = {
		limit = {
			conference_supporters_percentage_value > 0.75
		}
		every_in_global_list = {
			variable = current_congress_members_on_stance_1
			$TARGET$ = {
				change_relations = {
					country = prev
					value = 50
				}
			}
		}
		$TARGET$ = {
			set_country_type = recognized
		}
	}
}

make_strategic_region_list = {
	# So when can reset, mostly for debugging purposes
	clear_global_variable_list ?= strategic_region_list
	every_state_region = {
		limit = {
			is_state_region_land = yes
		}
		if = {
			limit = {
				region = {
					NOT = {
						is_target_in_global_variable_list = {
							name = strategic_region_list
							target = this
						}
					}
				}
			}
		}
		region = {
			add_to_global_variable_list = {
				name = strategic_region_list
				target = this
			}
		}
	}
}
