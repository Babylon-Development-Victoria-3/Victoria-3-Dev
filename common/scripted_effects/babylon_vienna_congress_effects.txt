babylon_vienna_congress_compile_lists = {
	# Get rid of the previous list (if they exist, only relevant the first monthly tick)
	clear_global_variable_list ?= babylon_congress_great_powers
	clear_global_variable_list ?= babylon_congress_major_powers
	# Then we get the sorted countries
	ordered_country = {
		limit = {
			country_rank = rank_value:great_power
		}
		order_by = prestige
		max = babylon_num_of_great_powers
		add_to_global_variable_list = {
			name = babylon_congress_great_powers
			target = this
		}
	}
	ordered_country = {
		limit = {
			country_rank = rank_value:major_power
		}
		order_by = prestige
		max = babylon_num_of_major_powers
		add_to_global_variable_list = {
			name = babylon_congress_major_powers
			target = this
		}
	}
	every_country = {
		clear_variable_list ?= current_states
		every_scope_state = {
			prev = {
				add_to_variable_list = {
					name = current_states
					target = prev
				}
			}
		}
	}
}

congress_start_conference = {
	if = {
		limit = {
			# Only start conference if its not in session.
			# Shouldnt be neccesary, but here as redundancy
			NOT = {
				has_global_variable = babylon_vienna_congress_in_session
			}
		}
		# Remove previous global variables
		clear_global_variable_list ?= current_congress_members_on_stance_1
		clear_global_variable_list ?= current_congress_members_on_stance_2
		clear_global_variable_list ?= current_congress_members_on_stance_3
		clear_global_variable_list ?= current_congress_members_on_stance_4
		clear_global_variable_list ?= current_congress_members_on_observer_bench_stance_1
		clear_global_variable_list ?= current_congress_members_on_observer_bench_stance_2
		clear_global_variable_list ?= current_congress_members_on_observer_bench_stance_3
		clear_global_variable_list ?= babylon_vienna_congress_session_target_states
		clear_global_variable_list ?= babylon_vienna_congress_session_target_state_owners
		remove_global_variable ?= babylon_vienna_congress_session_target_single_state
		remove_global_variable ?= chosen_vienna_congress_target_region_or_culture_var
		remove_global_variable ?= chosen_vienna_congress_target_region_or_culture_type
		set_global_variable = {
			name = babylon_vienna_congress_in_session
		}
		set_global_variable = {
			name = babylon_vienna_congress_minimum_time
			days = 30
		}
		if = {
			limit = {
				NOT = {
					has_global_variable = babylon_vienna_congress_current_session
				}
			}
			set_global_variable = {
				name = babylon_vienna_congress_current_session
				value = 1
			}
		}
		else = {
			change_global_variable = {
				name = babylon_vienna_congress_current_session
				add = 1
			}
		}
		congress_initialise_conference_global_vars = {
			TYPE = $TYPE$
			TARGET = $TARGET$
			INITIATOR = $INITIATOR$
		}
		every_country = {
			limit = {
				NOT = {
					this = $INITIATOR$
				}
			}
			post_notification = babylon_vienna_congress_started
		}
		congress_send_out_invitation = yes
	}
}

aftermath_event_choice = {
	# NEEDS FILLING IN ACCORDING TO TYPE
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 1
		}
		trigger_event = {
			id = conference_aftermath_denouncement.1
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 2
		}
		trigger_event = {
			id = conference_aftermath_state_claim.1
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 3
		}
		trigger_event = {
			id = conference_aftermath_embargo.1
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 4
		}
		trigger_event = {
			id = conference_aftermath_recognition.1
			popup = yes
		}
	}
}

aftermath_event_consequence = {
	# NEEDS FILLING IN ACCORDING TO TYPE
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 1
		}
		trigger_event = {
			id = conference_aftermath_denouncement.2
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 2
		}
		trigger_event = {
			id = conference_aftermath_state_claim.2
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 3
		}
		trigger_event = {
			id = conference_aftermath_embargo.2
			popup = yes
		}
	}
	if = {
		limit = {
			global_var:babylon_vienna_congress_session_type = 4
		}
		trigger_event = {
			id = conference_aftermath_recognition.2
			popup = yes
		}
	}
}

congress_initialise_conference_global_vars = {
	set_global_variable = {
		name = babylon_vienna_congress_session_type
		value = $TYPE$
	}
	set_global_variable = {
		name = babylon_vienna_congress_session_target
		value = $TARGET$
	}
	set_global_variable = {
		name = babylon_vienna_congress_session_initiator
		value = $INITIATOR$
	}
	if = {
		limit = {
			$TYPE$ = 2
			# State Claim
		}
		every_in_list = {
			variable = congress_target_state_basket
			add_to_global_variable_list = {
				name = babylon_vienna_congress_session_target_states
				target = this
			}
			state_region = {
				every_scope_state = {
					owner = {
						limit = {
							NOT = {
								is_target_in_global_variable_list = {
									name = babylon_vienna_congress_session_target_state_owners
									target = this
								}
							}
						}
						add_to_global_variable_list = {
							name = babylon_vienna_congress_session_target_state_owners
							target = this
						}
					}
				}
			}
		}
		if = {
			limit = {
				variable_list_size = {
					name = congress_target_state_basket
					value = 1
				}
			}
			every_in_list = {
				variable = congress_target_state_basket
				set_global_variable = {
					name = babylon_vienna_congress_session_target_single_state
					value = this
				}
			}
		}
		else = {
			every_in_list = {
				variable = congress_target_state_basket
				region = {
					if = {
						limit = {
							NOT = {
								is_target_in_local_variable_list = {
									name = strategic_regions_in_congress_target
									target = this
								}
							}
						}
						add_to_local_variable_list = {
							name = strategic_regions_in_congress_target
							target = this
						}
					}
				}
				every_scope_culture = {
					limit = {
						has_homeland = prev
					}
					if = {
						limit = {
							NOT = {
								is_target_in_local_variable_list = {
									name = homeland_cultures_in_congress_target
									target = this
								}
							}
						}
						add_to_local_variable_list = {
							name = homeland_cultures_in_congress_target
							target = this
						}
					}
				}
			}
			save_temporary_scope_value_as = {
				name = highest_congress_target_fraction
				value = 0
			}
			every_in_local_list = {
				variable = strategic_regions_in_congress_target
				set_local_variable = {
					name = strategic_region
					value = this
				}
				if = {
					limit = {
						babylon_vienna_congress_session_target_region_strategic_fraction >= scope:highest_congress_target_fraction
					}
					save_temporary_scope_value_as = {
						name = highest_congress_target_fraction
						value = babylon_vienna_congress_session_target_region_strategic_fraction
					}
					set_global_variable = {
						name = chosen_vienna_congress_target_region_or_culture_var
						value = this
					}
					set_global_variable = {
						name = chosen_vienna_congress_target_region_or_culture_type
						value = 1
					}
				}
			}
			every_in_local_list = {
				variable = homeland_cultures_in_congress_target
				set_local_variable = {
					name = culture_var
					value = this
				}
				if = {
					limit = {
						babylon_vienna_congress_session_target_region_culture_fraction >= scope:highest_congress_target_fraction
					}
					save_temporary_scope_value_as = {
						name = highest_congress_target_fraction
						value = babylon_vienna_congress_session_target_region_culture_fraction
					}
					set_global_variable = {
						name = chosen_vienna_congress_target_region_or_culture_var
						value = this
					}
					set_global_variable = {
						name = chosen_vienna_congress_target_region_or_culture_type
						value = 2
					}
				}
			}
		}
	}
}

set_congress_stance_effect = {
	if = {
		limit = {
			is_target_in_global_variable_list = {
				name = current_congress_members_on_stance_1
				target = $COUNTRY$
			}
		}
		remove_list_global_variable = {
			name = current_congress_members_on_stance_1
			target = $COUNTRY$
		}
	}
	if = {
		limit = {
			is_target_in_global_variable_list = {
				name = current_congress_members_on_stance_2
				target = $COUNTRY$
			}
		}
		remove_list_global_variable = {
			name = current_congress_members_on_stance_2
			target = $COUNTRY$
		}
	}
	if = {
		limit = {
			is_target_in_global_variable_list = {
				name = current_congress_members_on_stance_3
				target = $COUNTRY$
			}
		}
		remove_list_global_variable = {
			name = current_congress_members_on_stance_3
			target = $COUNTRY$
		}
	}
	if = {
		limit = {
			is_target_in_global_variable_list = {
				name = current_congress_members_on_stance_4
				target = $COUNTRY$
			}
		}
		remove_list_global_variable = {
			name = current_congress_members_on_stance_4
			target = $COUNTRY$
		}
	}
	add_to_global_variable_list = {
		name = current_congress_members_on_stance_$STANCE$
		target = $COUNTRY$
	}
	if = {
		limit = {
			$STANCE$ = 4
		}
		update_observer_bench = yes
	}
	else = {
		every_subject_or_below = {
			update_observer_bench = yes
		}
	}
}

# Country scope
update_observer_bench = {
	if = {
		limit = {
			is_target_in_global_variable_list = {
				name = current_congress_members_on_stance_4
				target = this
			}
		}
		if = {
			limit = {
				top_overlord = {
					is_target_in_global_variable_list = {
						name = current_congress_members_on_stance_1
						target = this
					}
				}
			}
			add_to_global_variable_list = {
				name = current_congress_members_on_observer_bench_stance_1
				target = this
			}
			remove_list_global_variable = {
				name = current_congress_members_on_observer_bench_stance_2
				target = this
			}
			remove_list_global_variable = {
				name = current_congress_members_on_observer_bench_stance_3
				target = this
			}
		}
		else_if = {
			limit = {
				top_overlord = {
					is_target_in_global_variable_list = {
						name = current_congress_members_on_stance_3
						target = this
					}
				}
			}
			remove_list_global_variable = {
				name = current_congress_members_on_observer_bench_stance_1
				target = this
			}
			remove_list_global_variable = {
				name = current_congress_members_on_observer_bench_stance_2
				target = this
			}
			add_to_global_variable_list = {
				name = current_congress_members_on_observer_bench_stance_3
				target = this
			}
		}
		else = {
			remove_list_global_variable = {
				name = current_congress_members_on_observer_bench_stance_1
				target = this
			}
			add_to_global_variable_list = {
				name = current_congress_members_on_observer_bench_stance_2
				target = this
			}
			remove_list_global_variable = {
				name = current_congress_members_on_observer_bench_stance_3
				target = this
			}
		}
	}
}

# Needs to be in country scope
adjust_opinions_conference_voters_reject = {
	every_in_global_list = {
		variable = current_congress_members_on_stance_1
		limit = {
			this != prev
			is_congress_target = no
			this != global_var:babylon_vienna_congress_session_initiator
		}
		prev = {
			change_relations = {
				country = prev
				value = {
					add = -50
					multiply = conference_sanctions_severity
				}
			}
		}
	}
	every_in_global_list = {
		variable = current_congress_members_on_stance_3
		limit = {
			this != prev
			is_congress_target = no
			this != global_var:babylon_vienna_congress_session_initiator
		}
		prev = {
			change_relations = {
				country = prev
				value = {
					add = 50
					multiply = conference_sanctions_severity
				}
			}
		}
	}
}

# scope: country
# defined: scope:target_country
denounce_target = {
	change_relations = {
		country = scope:target_country
		value = {
			add = -50
			multiply = conference_sanctions_severity
		}
	}
}

# scope: country
denouncement_effect = {
	if = {
		limit = {
			conference_sanctions_severity != 0
		}
		add_modifier = {
			name = babylon_congress_denouncement_modifier
			years = 3
			multiplier = conference_sanctions_severity
		}
		save_temporary_scope_value_as = {
			name = infamy_addition
			value = {
				add = 30
				multiply = conference_sanctions_severity
			}
		}
		change_infamy = scope:infamy_addition
	}
}

state_claim_effect_for_claimer = {
	if = {
		limit = {
			has_enough_support_for_state_claim = yes
		}
		every_in_global_list = {
			variable = babylon_vienna_congress_session_target_states
			state_region = {
				add_claim = global_var:babylon_vienna_congress_session_initiator
			}
		}
		every_country = {
			limit = {
				is_congress_target = yes
			}
			change_relations = {
				country = global_var:babylon_vienna_congress_session_initiator
				value = -50
			}
		}
	}
}

# scope: country
denounce_state_claimer = {
	if = {
		limit = {
			root != global_var:babylon_vienna_congress_session_initiator
		}
		every_country = {
			limit = {
				is_congress_target = yes
			}
			root = {
				change_relations = {
					country = prev
					value = {
						value = 50
						multiply = conference_sanctions_severity
					}
				}
			}
		}
		change_relations = {
			country = global_var:babylon_vienna_congress_session_initiator
			value = {
				value = -50
				multiply = conference_sanctions_severity
			}
		}
	}
}

# scope: country (the embargoer)
embargo_target = {
	if = {
		limit = {
			conference_sanctions_severity > 0
		}
		change_relations = {
			country = $TARGET$
			value = {
				add = -50
				multiply = conference_sanctions_severity
			}
		}
		create_diplomatic_pact = {
			country = $TARGET$
			type = forced_embargo_pact
		}
	}
}

# scope: country (the target)
embargo_effect = {
	if = {
		limit = {
			conference_sanctions_severity > 0
		}
		add_modifier = {
			name = forced_embargo
			years = 3
			multiplier = conference_sanctions_severity
		}
	}
}

recognise_effect = {
	if = {
		limit = {
			has_enough_support_for_recognition = yes
		}
		set_country_type = recognized
	}
}

make_strategic_region_list = {
	# So when can reset, mostly for debugging purposes
	clear_global_variable_list ?= strategic_region_list
	every_state_region = {
		limit = {
			is_state_region_land = yes
		}
		if = {
			limit = {
				region = {
					NOT = {
						is_target_in_global_variable_list = {
							name = strategic_region_list
							target = this
						}
					}
				}
			}
		}
		region = {
			add_to_global_variable_list = {
				name = strategic_region_list
				target = this
			}
		}
	}
}

congress_send_out_invitation = {
	every_country = {
		limit = {
			OR = {
				is_country_type = recognized
				is_country_type = colonial
			}
		}
		if = {
			limit = {
				is_congress_target = yes
			}
			trigger_event = {
				id = babylon_vienna_congress.2
				popup = yes
			}
		}
		else_if = {
			limit = {
				global_var:babylon_vienna_congress_session_initiator = this
			}
			set_variable = voting_conference_member
			set_congress_stance_effect = {
				COUNTRY = this
				STANCE = 1
			}
		}
		else_if = {
			limit = {
				global_var:babylon_vienna_congress_session_initiator != this
				global_var:babylon_vienna_congress_session_target != this
				OR = {
					is_target_in_global_variable_list = {
						name = babylon_congress_great_powers
						target = this
					}
					is_target_in_global_variable_list = {
						name = babylon_congress_major_powers
						target = this
					}
				}
			}
			trigger_event = {
				id = babylon_vienna_congress.2
				popup = yes
			}
		}
		else = {
			trigger_event = {
				id = babylon_vienna_congress.3
				popup = yes
			}
		}
	}
}
